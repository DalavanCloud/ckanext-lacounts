{% ckan_extends %}

{% block scripts %}
  {{ super() }}
  {% resource 'lacounts/library.js' %}
{% endblock %}

{% block subtitle %}{{ _("Library") }}{% endblock %}

{% block breadcrumb_content %}
  <li class="active">{{ h.nav_link(_("Library"), named_route='%s_search' % dataset_type, highlight_actions = 'new index') }}</li>
{% endblock %}

{% block primary_content %}
  <h1>{{ _("Library") }}</h1>
  <div class="helper-info" id="libraryHelper">
    <h4 class="header"><span class="sr-only">What is this</span>?</h4>
    <div class="content">
      <p>
        {{ _("Welcome to the LA Counts Library! Harvested from federal, state, regional, and local data publishers, these open datasets and related data stories collectively describe what we know and what we don't know about Los Angeles County. Use this data to examine governmental complexities, explain how things work, and explore the potential for social change in and across Los Angeles County.") }}
      </p>
    </div>
  </div>

  {% block results_filters %}
    <div class="results_filters">
      {% set facets = {
        'fields': c.fields_grouped,
        'search': c.search_facets,
        'titles': c.facet_titles,
        'translated_fields': c.translated_fields,
        'remove_field': c.remove_field }
      %}
      {% for field in facets.fields %}
        {% set search_facets_items = facets.search.get(field)['items'] %}
        {% for value in facets.fields[field] %}
          <span class="filtered pill">
            {%- if facets.translated_fields and facets.translated_fields.has_key((field,value)) -%}
              {{ facets.translated_fields[(field,value)] }}
            {%- else -%}
              {{ h.list_dict_filter(search_facets_items, 'name', 'display_name', value) }}
            {%- endif %}
            <a href="{{ facets.remove_field(field, value) }}" class="remove-filter" title="{{ _('Remove') }}">
              <i class="fa fa-times"></i>
            </a>
          </span>
        {% endfor %}
      {% endfor %}
      {% if facets.fields|length > 0 %}
        <a href="/dataset" class="remove-all">{{ _('Remove all filters') }}</a>
      {% endif %}
      <a class="show-filters btn btn-default">{{ _('Filter Results') }}</a>
    </div>
  {% endblock %}

    {% if c.page.item_count %}
      {% block results_limit %}
      <form id="results-controls" class="results-controls" data-module="select-switch">

        {% block search_search_fields %}
          <div style="display:none">
            {% if c.fields -%}
              <span>{{ form.hidden_from_list(fields=c.fields) }}</span>
            {%- endif %}
            {% if c.q -%}
              <span>{{ form.hidden('q', c.q) }}</span>
            {%- endif %}
          </div>
        {% endblock %}

        <div class="number-of-results">
          <span class="sr-only">Showing {{ c.page.items_per_page }}</span>
          <span class="total">&nbsp;of <strong>{{ c.page.item_count }}</strong> results.</span>
          <span class="to-show">Show
            {% for limit in [25, 50, 100] %}
              {% set active = 'class="active"' if c.page.items_per_page == limit else '' %}
              {% set link = 'href="%s"' % h.update_url_query(h.current_url(), {'limit': limit, 'page': None}) if not active else '' %}
              <a {{ active | safe }} {{ link | safe }}>{{ limit }}</a>
              {% if not loop.last %}
                <em class="sr-only">or</em>
              {% endif %}
            {% endfor %}
          </span>
        </div>
      {% endblock %}

      {% block results_order %}
        {% set sorting_selected = c.sort_by_selected %}
        {% set sorting = [
          (_('Relevance'), 'score desc, metadata_modified desc'),
          (_('Name Ascending'), 'title_string asc'),
          (_('Name Descending'), 'title_string desc'),
          (_('Last Modified'), 'metadata_modified desc'),
          (_('Popular'), 'views_recent desc') if g.tracking_enabled else (false, false) ]
        %}
        <div class="form-select form-group control-order-by">
          <label for="field-order-by">{{ _('Order by') }}</label>
          <select id="field-order-by" name="sort" class="form-control">
            {% for label, value in sorting %}
              {% if label and value %}
                <option value="{{ value }}"{% if sorting_selected == value %} selected="selected"{% endif %}>{{ label }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </form>
      {% endblock %}

  {% else %}
    <h2>{{ _('No results found for "{}"').format(c.q) }}</h2>
    <p class="extra">Please try another search, or perhaps you would like to <a href="https://goo.gl/forms/Zcxkp5Q3rTccG6712">suggest a dataset</a> or a <a href="https://goo.gl/forms/rQNVca7JuOdMewgH3">story</a>?
  {% endif %}



  {% block package_search_results_list %}
    {{ h.snippet('snippets/package_list.html', packages=c.page.items) }}
  {% endblock %}

  {% block page_pagination %}
    {{ c.page.pager(q=c.q) }}
  {% endblock %}

{% endblock %}


{% block footer %}
  {% if h.check_access('package_create') %}
    <div class="admin-page-actions">
      {% snippet 'snippets/add_lib_item.html' %}
    </div>
  {% endif %}
  {{ super() }}
{% endblock %}
